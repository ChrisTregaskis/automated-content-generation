# Workflow 4: Slack Notifier

## Overview

The Slack Notifier workflow reads draft content files generated by Workflow 3 and posts a formatted review request to Slack with interactive approval buttons.

### What It Does

1. **Receives draft file path** â€” via manual trigger with test data (webhook trigger for production)
2. **Reads draft JSON** â€” loads the draft file from `/data/shared/output/drafts/`
3. **Parses draft content** â€” extracts all fields needed for the Slack message
4. **Looks up image URL** â€” maps local image paths to public URLs for display
5. **Builds Slack Block Kit message** â€” creates a rich formatted message with image, content sections, metadata, and action buttons
6. **Posts to Slack** â€” sends message to `#content-review` channel via HTTP Request
7. **Outputs confirmation** â€” captures message timestamp for use by Workflow 5

### Output

A Slack message in `#content-review` containing:

- Header with draft ID
- Image preview (from public URL)
- Headline, body copy, CTA, and hashtags
- Metadata context (platform, theme, vehicle, character count)
- Interactive buttons: Approve, Reject, Request Changes

The workflow also outputs the Slack message timestamp (`ts`) and channel ID, which Workflow 5 will use to update the message after approval/rejection.

---

## Workflow Structure

```
[Manual Trigger]
       â”‚
       â–¼
[Set Test Data] â”€â”€â–º (provides draft file path)
       â”‚
       â–¼
[Read Draft File] â†’ [Extract Draft JSON] â†’ [Parse Draft]
       â”‚
       â–¼
[Build Slack Blocks]
       â”‚
       â–¼
[Send to Slack] (HTTP Request)
       â”‚
       â–¼
[Output Confirmation]
```

### Node Summary

| Node                | Type              | Purpose                                              |
| ------------------- | ----------------- | ---------------------------------------------------- |
| Manual Trigger      | Trigger           | Starts workflow                                      |
| Set Test Data       | Set               | Injects test draft file path                         |
| Read Draft File     | Read/Write Files  | Loads draft JSON as binary                           |
| Extract Draft JSON  | Extract From File | Converts binary to string                            |
| Parse Draft         | Code              | Parses JSON, extracts fields, looks up image URL     |
| Build Slack Blocks  | Code              | Constructs Slack Block Kit JSON with image & buttons |
| Send to Slack       | HTTP Request      | POSTs to Slack chat.postMessage API                  |
| Output Confirmation | Set               | Captures message ts, channel, and status             |

---

## Slack Block Kit Structure

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“ Content Review Request                  â”‚
â”‚  Draft ID: draft-20260105T163210-10sugc     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [â•â•â•â•â•â•â• IMAGE PREVIEW â•â•â•â•â•â•â•]            â”‚
â”‚  ğŸ“· Image: products/supersports-detail.jpg  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  *Headline*                                 â”‚
â”‚  "Precision Meets Passion"                  â”‚
â”‚                                             â”‚
â”‚  *Body Copy*                                â”‚
â”‚  Each Continental GT bears the mark of      â”‚
â”‚  master craftsmen...                        â”‚
â”‚                                             â”‚
â”‚  *Call to Action*                           â”‚
â”‚  Discover the Art of Creation               â”‚
â”‚                                             â”‚
â”‚  *Hashtags*                                 â”‚
â”‚  #BentleyMotors #Craftsmanship ...          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Platform: instagram | Theme: craftsmanship â”‚
â”‚  Characters: 274/2200 | Valid: âœ…            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [âœ… Approve]  [âŒ Reject]  [âœï¸ Changes]    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Prerequisites

### Slack Setup

1. Slack workspace with `#content-review` channel
2. Slack app created at api.slack.com with:
   - Bot Token scopes: `chat:write`, `chat:write.public`, `files:write`, `channels:read`
   - Interactivity enabled (for button clicks â€” used by Workflow 5)
3. n8n credential: **Slack API** type with Bot Token (`xoxb-...`)
4. HTTP Request credential: **Header Auth** with `Authorization: Bearer xoxb-...`

### File Dependencies

- Draft files in `/data/shared/output/drafts/` (created by Workflow 3)
- Image manifest with URLs: `/data/shared/marketing-assets/images/images-manifest.json`

---

## Testing the Workflow

### Manual Execution

1. Open n8n at http://localhost:5678
2. Open the "Slack Notifier" workflow
3. Ensure "Set Test Data" contains a valid draft file path
4. Click **Test workflow**
5. Check `#content-review` channel in Slack

### Verify Output

The "Output Confirmation" node should contain:

```json
{
  "status": "sent",
  "draftId": "draft-20260105T163210-10sugc",
  "slackMessageTs": "1767693300.000859",
  "slackChannel": "C0A6UP3NK43"
}
```

---

## Technical Notes

### Why HTTP Request Instead of Native Slack Node

The native n8n Slack node with "Block Kit" message type doesn't reliably render blocks â€” only the fallback text appears. Using HTTP Request to call `chat.postMessage` directly ensures proper Block Kit rendering.

### Image URL Handling

The workflow includes a lookup map to convert local image paths to public URLs. This is needed because:

1. Slack can only display images from publicly accessible URLs
2. Existing draft files were created before URLs were added to the image manifest

Future enhancement: Update Workflow 2 (Content Assembler) to include `url` in the selected image data, eliminating the need for the lookup map.

### Button Action IDs

The buttons use these action IDs (used by Workflow 5):

| Button             | action_id         | value   |
| ------------------ | ----------------- | ------- |
| âœ… Approve         | `approve_content` | draftId |
| âŒ Reject          | `reject_content`  | draftId |
| âœï¸ Request Changes | `request_changes` | draftId |

---

## Troubleshooting

### Message Shows Only Fallback Text

- Ensure you're using HTTP Request node, not native Slack node
- Verify the `blocks` field contains valid JSON array
- Check Slack API response for error messages

### Image Not Displaying

- Verify the image URL is publicly accessible (test in browser)
- Check that `imageUrl` is being set in "Parse Draft" output
- Slack may cache images â€” try a different image URL to test

### Authentication Errors

- Verify Bot Token starts with `xoxb-`
- Check the Header Auth credential has `Authorization` as the header name
- Ensure the value is `Bearer xoxb-...` (with space after Bearer)

### Channel Not Found

- Use channel name without `#` prefix, or use channel ID
- Ensure bot has been invited to private channels (public channels work automatically with `chat:write.public`)

---

## File Paths

| Resource    | Container Path                      |
| ----------- | ----------------------------------- |
| Draft Input | `/data/shared/output/drafts/*.json` |
| Image URLs  | Public URLs from artofbrand.se      |

---

## Next Steps

- **Workflow 5: Approval Handler** â€” Webhook to receive button clicks and process approvals
- **Update Workflow 2** â€” Include image URL in content package for future drafts
